<div class="report-container">
  <div class="report-header">
    <div class="header-content">
      <div>
        <h1>{{ report?.title || 'Report #' + reportId }}</h1>
        <div class="report-type" *ngIf="report?.type">{{ report?.type | titlecase }}</div>
        <a routerLink="/dashboard" class="btn-link">‚Üê Back to Dashboard</a>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" (click)="editReport()">Edit</button>
        <button class="btn btn-secondary" (click)="downloadReport('docx')">Download DOCX</button>
        <button class="btn btn-secondary" (click)="downloadReport('pdf')">Download PDF</button>
        <button class="btn btn-secondary" (click)="togglePdf()">
          {{ showPdf ? 'Hide' : 'Preview' }} PDF
        </button>
        <button class="btn btn-primary" (click)="toggleChat()">
          {{ showChat ? 'Hide' : 'Show' }} Chat
        </button>
      </div>
    </div>
  </div>

  <div class="report-content-wrapper">
    <div class="report-content" [class.with-chat]="showChat">
      <div *ngIf="loading" class="loading">Loading report...</div>
      <div *ngIf="error" class="error-message">{{ error }}</div>

      <div *ngIf="report && !loading" class="report-body">
        <div class="report-meta">
          <span class="meta-item">
            Status:
            <span class="status-badge" [ngClass]="'status-' + (report.status || 'pending')">
              {{ report.status || 'pending' }}
            </span>
          </span>
          <span class="meta-item">Created: {{ report.created_at | date:'medium' }}</span>
          <span class="meta-item" *ngIf="report.updated_at && report.updated_at !== report.created_at">Updated: {{
            report.updated_at | date:'medium' }}</span>
          <span class="meta-item" *ngIf="report.generated_at">Generated: {{ report.generated_at | date:'medium'
            }}</span>
          <span class="meta-item">Version: {{ report.version }}</span>
          <span class="meta-item" *ngIf="report.content?.citations">
            Citations: {{ report.content.citations.length }}
          </span>
        </div>

        <!-- Metadata Section -->
        <div class="metadata-section" *ngIf="report.report_metadata">
          <h3>Report Details</h3>
          <div class="metadata-grid">
            <div class="meta-pair" *ngIf="report.report_metadata.verification_score">
              <span class="label">Verification Score:</span>
              <span class="value">{{ report.report_metadata.verification_score }}</span>
            </div>
            <div class="meta-pair" *ngIf="report.report_metadata.compliance_assessment">
              <span class="label">Compliance:</span>
              <span class="value">{{ report.report_metadata.compliance_assessment }}</span>
            </div>
          </div>
        </div>

        <div class="report-text">
          <!-- Structured Content Display -->
          <div *ngIf="report.content?.executive_summary" class="section">
            <h3>Executive Summary</h3>
            <div [innerHTML]="parseContent(report.content.executive_summary)"></div>
          </div>

          <div *ngIf="report.content?.findings" class="section">
            <h3>Findings</h3>
            <ul>
              <li *ngFor="let finding of report.content.findings">{{ finding }}</li>
            </ul>
          </div>

          <div *ngIf="report.content?.risks" class="section">
            <h3>Risks</h3>
            <ul>
              <li *ngFor="let risk of report.content.risks">{{ risk }}</li>
            </ul>
          </div>

          <!-- Fallback for unstructured content -->
          <div *ngIf="!report.content?.executive_summary && report.content?.full_text"
            [innerHTML]="parseContent(report.content.full_text)">
          </div>

          <div *ngIf="!report.content?.executive_summary && !report.content?.full_text && isString(report.content)"
            [innerHTML]="parseContent(report.content)">
          </div>
        </div>

        <!-- Citations Section -->
        <!-- Citations Section -->
        <div *ngIf="report.content?.citations && report.content.citations.length > 0" class="citations-section">
          <h3>Citations</h3>
          <div class="citations-list">
            <div *ngFor="let citation of report.content.citations; let i = index" class="citation-item">
              <span class="citation-number">[{{ i + 1 }}]</span>
              <div class="citation-content">
                <div class="citation-title" *ngIf="citation.title">{{ citation.title }}</div>
                <div class="citation-url" *ngIf="citation.url">
                  <a [href]="citation.url" target="_blank">{{ citation.url }}</a>
                </div>
                <div class="citation-snippet" *ngIf="citation.snippet || citation.text">{{ citation.snippet ||
                  citation.text }}</div>
              </div>
            </div>
          </div>

          <!-- PDF Preview Panel -->
          <div class="pdf-panel" *ngIf="showPdf">
            <div class="pdf-container">
              <iframe [src]="pdfPreviewUrl" width="100%" height="800px" frameborder="0"></iframe>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Chat Panel -->
    <div class="chat-panel" *ngIf="showChat">
      <div class="chat-header">
        <h3>Chat about this Report</h3>
        <p class="chat-subtitle">Ask questions about the report content</p>
      </div>

      <div class="chat-messages">
        <div *ngFor="let message of messages" class="message" [ngClass]="'message-' + message.role">
          <div class="message-header">
            <span class="message-role">{{ message.role === 'user' ? 'You' : 'Assistant' }}</span>
            <span class="message-time">{{ message.timestamp | date:'short' }}</span>
          </div>
          <div class="message-content">{{ message.content }}</div>
        </div>
        <div *ngIf="chatLoading" class="message message-assistant">
          <div class="message-content">Thinking...</div>
        </div>
      </div>

      <div class="chat-input-area">
        <form (ngSubmit)="sendChatMessage()" class="chat-form">
          <input type="text" [(ngModel)]="chatInput" name="chatInput" class="chat-input"
            placeholder="Ask a question about the report..." [disabled]="chatLoading" />
          <button type="submit" class="btn btn-primary" [disabled]="chatLoading || !chatInput.trim()">
            Send
          </button>
        </form>
      </div>
    </div>
  </div>
</div>